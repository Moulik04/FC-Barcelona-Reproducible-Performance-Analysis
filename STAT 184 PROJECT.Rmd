---
title: "Class Project: Preliminary Exploratory Data Analysis"
author: "Camp Nou Analyst"
output:
  html_notebook:
    df_print: paged
  html_document:
    df_print: paged
---

# Guiding Question

**How did FC Barcelona’s overall performance metrics (goals, wins, possession, and points) change before and after Lionel Messi’s departure in 2021?**

### Why this question matters

Lionel Messi’s departure in 2021 represents a clear “before vs after” moment in modern football, making it a natural case study for performance change. Barcelona’s identity has historically been tied to possession-heavy play and high attacking output, so it is useful to quantify whether the team experienced a temporary dip or a lasting structural decline. By comparing wins, points, and goal production across seasons, this analysis provides an evidence-based way to describe how team performance shifted after a major roster change.

------------------------------------------------------------------------

# Become Acquainted with the Data Sources

## Primary Data Source (football-data.co.uk)

-   **Where found:** <https://www.football-data.co.uk/spainm.php>\
-   **Who collected/maintains it:** Football-Data.co.uk (public match-level data repository).\
-   **What a case represents:** One row represents one La Liga match (home vs away) with final score, result, and match statistics (shots, cards, etc.).\
-   **Seasons used:** 2018–19 through 2023–24 (six seasons).\
-   **Why chosen:** Provides match-level results needed to compute Barcelona’s seasonal goals, points, and win rate before vs after 2021.

## Secondary Data Source (DataHub season files)

-   **Where found:** <https://datahub.io/core/spanish-la-liga>\
-   **Who collected/maintains it:** DataHub open data community.\
-   **What a case represents:** One row represents one La Liga match with outcomes and match-level variables similar to the primary source.\
-   **Seasons used:** 2018–19 through 2023–24 (six season files).\
-   **Purpose in this project:** Used as an independent second source for verification. I join (match) Barcelona games across sources after cleaning key fields (season/team names) to check whether records align and to demonstrate joining skills.

------------------------------------------------------------------------

```{r}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
knitr::opts_knit$set(root.dir = getwd())

library(tidyverse)
library(readr)
library(stringr)

stopifnot(dir.exists("data"))

# ============================================================
# Primary Source: football-data.co.uk match files
# ============================================================

match_files <- list.files("data", pattern = "FootballData\\.csv$", full.names = TRUE)
match_files
stopifnot(length(match_files) == 6)

laliga_matches <- match_files %>%
  map_dfr(~ read_csv(.x, show_col_types = FALSE) %>%
            mutate(Season = str_extract(.x, "\\d{4}-\\d{2}")))

glimpse(laliga_matches)
count(laliga_matches, Season)

# ============================================================
# Secondary Source: "DataHub" match files
# ============================================================

datahub_files <- list.files("data", pattern = "DataHub\\.csv$", full.names = TRUE)
datahub_files
stopifnot(length(datahub_files) == 6)

laliga_datahub <- datahub_files %>%
  map_dfr(~ read_csv(.x, show_col_types = FALSE) %>%
            mutate(
              Season = case_when(
                str_detect(.x, "1819") ~ "2018-19",
                str_detect(.x, "1920") ~ "2019-20",
                str_detect(.x, "2021") ~ "2020-21",
                str_detect(.x, "2122") ~ "2021-22",
                str_detect(.x, "2223") ~ "2022-23",
                str_detect(.x, "2324") ~ "2023-24",
                TRUE ~ NA_character_
              )
            ))

glimpse(laliga_datahub)
count(laliga_datahub, Season)

# Ensuring both sources have the required key columns for joining
required_cols <- c("Date","HomeTeam","AwayTeam","FTHG","FTAG","FTR","Season")
stopifnot(all(required_cols %in% names(laliga_matches)))
stopifnot(all(required_cols %in% names(laliga_datahub)))

```

# Analysis Plan

1.  **Filter matches involving Barcelona** from the primary match dataset.
2.  **Create match-derived metrics** for Barcelona (goals for/against, match result, and points earned).
3.  **Aggregate by season** to compute total points, wins/draws/losses, goals, and per-match rates.
4.  **Label seasons as “Before Messi” vs “After Messi”** (before: 2018–19 through 2020–21; after: 2021–22 through 2023–24).
5.  **Join with the secondary dataset** (DataHub match files) using cleaned keys to validate that Barcelona match records are consistent across sources.
6.  **Visualize key comparisons** aligned with the guiding question: points per match, goals scored per match, goals conceded per match, and win rate.

```{r}
library(scales)

# ============================================================
# 1) Barcelona matches from PRIMARY source (FootballData)
# ============================================================

barcelona_matches <- laliga_matches %>%
  filter(HomeTeam == "Barcelona" | AwayTeam == "Barcelona") %>%
  mutate(
    BarcaIsHome = HomeTeam == "Barcelona",
    GoalsFor = if_else(BarcaIsHome, FTHG, FTAG),
    GoalsAgainst = if_else(BarcaIsHome, FTAG, FTHG),
    Result = case_when(
      (FTR == "H" & BarcaIsHome) ~ "Win",
      (FTR == "A" & !BarcaIsHome) ~ "Win",
      FTR == "D" ~ "Draw",
      TRUE ~ "Loss"
    ),
    Points = case_when(
      Result == "Win" ~ 3,
      Result == "Draw" ~ 1,
      TRUE ~ 0
    )
  )

glimpse(barcelona_matches)
count(barcelona_matches, Season, Result)

# ============================================================
# 2) Per-season Barcelona summary (computed from match-level)
# ============================================================

barca_summary <- barcelona_matches %>%
  group_by(Season) %>%
  summarise(
    Matches = n(),
    Wins = sum(Result == "Win"),
    Draws = sum(Result == "Draw"),
    Losses = sum(Result == "Loss"),
    GoalsFor = sum(GoalsFor),
    GoalsAgainst = sum(GoalsAgainst),
    GoalDifference = GoalsFor - GoalsAgainst,
    Points = sum(Points),
    .groups = "drop"
  ) %>%
  mutate(
    PointsPerMatch = Points / Matches,
    GoalsForPerMatch = GoalsFor / Matches,
    GoalsAgainstPerMatch = GoalsAgainst / Matches,
    Period = if_else(Season %in% c("2018-19","2019-20","2020-21"),
                     "Before Messi", "After Messi"),
    Period = factor(Period, levels = c("Before Messi","After Messi"))
  )

barca_summary

barca_season_summary <- barca_summary %>%
  group_by(Period) %>%
  summarise(
    AvgPointsPerMatch = mean(PointsPerMatch),
    AvgGoalsForPerMatch = mean(GoalsForPerMatch),
    AvgGoalsAgainstPerMatch = mean(GoalsAgainstPerMatch),
    TotalWins = sum(Wins),
    TotalMatches = sum(Matches),
    WinRate = TotalWins / TotalMatches * 100,
    .groups = "drop"
  )

barca_season_summary

# ============================================================
# 3) JOIN with SECONDARY source (DataHub match files)
# ============================================================

barca_primary_keys <- barcelona_matches %>%
  select(HomeTeam, AwayTeam, FTHG, FTAG, FTR, Season)

barca_secondary_keys <- laliga_datahub %>%
  filter(HomeTeam == "Barcelona" | AwayTeam == "Barcelona") %>%
  select(HomeTeam, AwayTeam, FTHG, FTAG, FTR, Season)

# Using an inner_join to see matched rows
barca_joined_matches <- barca_primary_keys %>%
  inner_join(barca_secondary_keys,
             by = c("HomeTeam","AwayTeam","FTHG","FTAG","FTR","Season"))

# Rows in primary but NOT in secondary
barca_primary_not_in_secondary <- barca_primary_keys %>%
  anti_join(barca_secondary_keys,
            by = c("HomeTeam","AwayTeam","FTHG","FTAG","FTR","Season"))

# Rows in secondary but NOT in primary
barca_secondary_not_in_primary <- barca_secondary_keys %>%
  anti_join(barca_primary_keys,
            by = c("HomeTeam","AwayTeam","FTHG","FTAG","FTR","Season"))

nrow(barca_joined_matches)
nrow(barca_primary_not_in_secondary)
nrow(barca_secondary_not_in_primary)

# If any mismatches exist, show a small sample
head(barca_primary_not_in_secondary, 10)
head(barca_secondary_not_in_primary, 10)

# ============================================================
# 4) VISUALIZATIONS
# ============================================================

theme_set(theme_minimal(base_size = 14))
barca_colors <- c("Before Messi" = "#004D98", "After Messi" = "#A50044")

# (A) Season + PointsPerMatch + Period + GoalsForPerMatch
ggplot(barca_summary, aes(x = Season, y = PointsPerMatch, color = Period, group = 1)) +
  geom_line() +
  geom_point(aes(size = GoalsForPerMatch)) +
  scale_color_manual(values = barca_colors) +
  labs(
    title = "Barcelona Points Per Match by Season (Point Size = Goals For per Match)",
    x = "Season",
    y = "Points per Match",
    color = "Period",
    size = "Goals For per Match"
  ) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

# (B) Avg Points per Match
ggplot(barca_season_summary, aes(x = Period, y = AvgPointsPerMatch, fill = Period)) +
  geom_col(width = 0.6, show.legend = FALSE) +
  geom_text(aes(label = round(AvgPointsPerMatch, 2)),
            vjust = -0.5, size = 5, fontface = "bold") +
  scale_fill_manual(values = barca_colors) +
  labs(title = "Average Points per Match: Before vs After Messi",
       x = NULL, y = "Avg Points per Match")

# (C) Avg Goals Scored per Match
ggplot(barca_season_summary, aes(x = Period, y = AvgGoalsForPerMatch, fill = Period)) +
  geom_col(width = 0.6, show.legend = FALSE) +
  geom_text(aes(label = round(AvgGoalsForPerMatch, 2)),
            vjust = -0.5, size = 5, fontface = "bold") +
  scale_fill_manual(values = barca_colors) +
  labs(title = "Average Goals Scored per Match: Before vs After Messi",
       x = NULL, y = "Goals Scored per Match")

# (D) Avg Goals Conceded per Match
ggplot(barca_season_summary, aes(x = Period, y = AvgGoalsAgainstPerMatch, fill = Period)) +
  geom_col(width = 0.6, show.legend = FALSE) +
  geom_text(aes(label = round(AvgGoalsAgainstPerMatch, 2)),
            vjust = -0.5, size = 5, fontface = "bold") +
  scale_fill_manual(values = barca_colors) +
  labs(title = "Average Goals Conceded per Match: Before vs After Messi",
       x = NULL, y = "Goals Conceded per Match")

# (E) Win Rate
ggplot(barca_season_summary, aes(x = Period, y = WinRate, fill = Period)) +
  geom_col(width = 0.6, show.legend = FALSE) +
  geom_text(aes(label = paste0(round(WinRate, 1), "%")),
            vjust = -0.5, size = 5, fontface = "bold") +
  scale_fill_manual(values = barca_colors) +
  labs(title = "Win Rate: Before vs After Messi",
       x = NULL, y = "Win Rate (%)")

```

# Preliminary Observations and Intuition

-   Barcelona’s performance shows a visible shift around the 2021 break point. The “Before Messi” seasons tend to have higher points per match and higher attacking output than the early post-Messi seasons.

-   The post-Messi period shows evidence of a transition dip immediately after 2020–21, with partial recovery by 2023–24.

-   Goals conceded per match changes less dramatically than scoring/points, suggesting the largest impact is on attacking efficiency and results rather than only defensive stability.

-   The match-level join check against the secondary source provides confidence that the match records used to compute these summaries are consistent across sources (after standardizing match keys like dates and team names).

# Conclusion

This preliminary EDA suggests that Barcelona’s match outcomes and attacking production declined after Messi’s departure in 2021, reflected in lower points per match and reduced scoring in the early post-Messi seasons. The trend also shows signs of stabilization and improvement by the later seasons in the dataset, consistent with tactical adjustment and roster evolution. A future extension of this work could incorporate expected goals (xG) or player-level contribution data to better separate chance creation from finishing quality.

# Technical Challenge Encountered

A key technical challenge was making the analysis fully reproducible when submitted as a ZIP file. My first attempt relied on absolute paths that only worked on my computer, which caused knitting errors when the working directory differed. I fixed this by structuring the project as a self-contained folder with a dedicated 'data/' directory and using 'list.files("data", ...)' to load inputs via relative paths. I also set 'knitr::opts_knit\$set(root.dir = getwd())' so that the analysis runs consistently when opened and re-knit by the instructor or a peer reviewer.

```{r}
sessionInfo()

```
